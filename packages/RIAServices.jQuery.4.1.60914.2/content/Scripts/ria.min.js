(function(n){function t(n){return this.data?(this._data=n,this):new t(n)}function s(n,t){if(n&&t){var i=t.split(".");t=i.pop();while(n&&i.length)n=n[i.shift()];return[n,t]}return[]}function r(n){return this.data?(this._data=n,this):new r(n)}function i(n){if(typeof n!="number"||n<0)throw"Invalid index.";}function f(i){return n.isArray(i)?new r(i):new t(i)}function o(n,t,i,r,u){var e=i[0],f;n._beforeChange&&n._beforeChange.call(n,e,r,u),f=t(u),f&&(u=f),n._afterChange&&n._afterChange.call(n,e,r,u),i.triggerHandler(r,u),n._afterEvent&&n._afterEvent.call(n,e,r,u)}var u="__observableFactory__",e;n.observable=function(t,i){var r=n.data(t,u),e=i&&!!i.useDefault;return r&&!e?r(t):f(t)},n.observable.track=function(t,i){if(i&&n.data(t,u))throw"Observable already tracked for this data.";var r=i?function(n){var t=f(n);return t._beforeChange=i.beforeChange,t._afterChange=i.afterChange,t._afterEvent=i.afterEvent,t}:null;n.data(t,u,r)},e=[].splice,n.observable.Object=t,t.prototype={_data:null,data:function(){return this._data},setProperty:function(t,i){var e,y,c,l,f,u,h,r,v,a;if(n.isArray(t))for(e=0,y=t.length;e<y;e++)c=t[e],this.setProperty(c.name,c.value);else if(typeof t=="object")for(l in t)this.setProperty(l,t[l]);else h=this._data,r=s(h,t),t=r[1],r=r[0],r&&(u=r[t],n.isFunction(u)&&(f=u,u=u.call(r)),v={path:t,value:i},a=function(n){return f?(f.call(r,i),n.value=f.call(r)):r[t]=i,n},o(this,a,n(h),"propertyChange",v));return this}},n.observable.Array=r,r.prototype={_data:null,data:function(){return this._data},insert:function(t,r){i(t);if(arguments.length>1){r=n.isArray(r)?r:[r];if(r.length>0){var o=this,f=function(){e.apply(o._data,[t,0].concat(r))},u={change:"insert",index:t,items:r};this._changeDataAndTriggerEvents(f,u)}}return this},remove:function(n,t){i(n),t=t===undefined||t===null?1:t;if(t){var f=this,e=function(){f._data.splice(n,t)},r=this._data.slice(n,n+t),u={change:"remove",index:n,items:r};this._changeDataAndTriggerEvents(e,u)}return this},move:function(n,t,r){i(n),i(t),r=r===undefined||r===null?1:r;if(r){var u=this,f=this._data.slice(n,n+r),o=function(){u._data.splice(n,r),u._data.splice.apply(u._data,[t,0].concat(f))},e={change:"move",oldIndex:n,newIndex:t,items:f};this._changeDataAndTriggerEvents(o,e)}return this},refresh:function(n){var t=this,r=function(){t._data.splice.apply(t._data,[0,t._data.length].concat(n))},i={change:"refresh",oldItems:this._data.slice(0),newItems:n};return this._changeDataAndTriggerEvents(r,i),this},_changeDataAndTriggerEvents:function(t,i){o(this,t,n([this._data]),"arrayChange",i)}}})(jQuery),(function(n){function i(n,t){for(var i in t)n[i]=t[i]}function u(t){for(var f=t.split("."),u=n,r,i=0;i<f.length;i++)r=u[f[i]],r&&typeof r=="object"||(u[f[i]]=r={}),u=r;return u}function f(n,t,r){return n=n||function(){},t&&i(n.prototype,t),r&&i(n,r),n}function e(n,t,r,u){var e=n.prototype,o={},f;i(o,e);if(r)for(f in r)o[f]=typeof r[f]=="function"&&typeof e[f]=="function"?function(n,t){return function(){var i=this._super,n;return this._super=e,n=t.apply(this,arguments),this._super=i,n}}(f,r[f]):r[f];return t=t?function(n){return function(){var t=this._super;this._super=e,n.apply(this,arguments),this._super=t}}(t):function(){},t.prototype=o,t.prototype.constructor=t,i(t,n),u&&i(t,u),t}var r=u("Microsoft.ServiceModel.DomainServices");r.defineNamespace=u,r.defineClass=f,r.deriveClass=e})(this),(function(n,t){function o(n,t){t?$.observable.track(n,{beforeChange:t.beforeChange,afterChange:t.afterChange,afterEvent:t.afterEvent}):$.observable.track(n,null)}function s(n,t,i){return function(){var r={change:"insert",index:t,items:i};$([n]).triggerHandler("arrayChange",r)}}function h(n,t,i){return function(){var r={change:"remove",index:t,items:i};$([n]).triggerHandler("arrayChange",r)}}function e(n,t,i){return function(){var r={change:"refresh",oldItems:t,newItems:i};$([n]).triggerHandler("arrayChange",r)}}function r(n,t,i,r){return function(){var i={path:t,value:r};$(n).triggerHandler("propertyChange",i)}}function u(n,t,i){$.observable(n).insert(t,i)}var f=t.defineNamespace("Microsoft.ServiceModel.DomainServices.Observability");f.Configuration={track:o,createInsertDeferredEvent:s,createRemoveDeferredEvent:h,createRefreshDeferredEvent:e,createSetPropertyDeferredEvent:r,observableInsert:u}})(this,Microsoft.ServiceModel.DomainServices),(function(n,t){function o(n,t){var i=r.Configuration&&r.Configuration.track;i(n,t)}function s(n,t,i){[].splice.apply(n,[t,0].concat(i));var u=r.Configuration&&r.Configuration.createInsertDeferredEvent;return u(n,t,i)}function h(n,t,i){var f=n.slice(t,t+i),u;return n.splice(t,i),u=r.Configuration&&r.Configuration.createRemoveDeferredEvent,u(n,t,f)}function u(n,t){var u=n.slice(0),i;return[].splice.apply(n,[0,n.length].concat(t)),i=r.Configuration&&r.Configuration.createRefreshDeferredEvent,i(n,u,t)}function f(n,t,i){var f=n[t],u;return n[t]=i,u=r.Configuration&&r.Configuration.createSetPropertyDeferredEvent,u(n,t,f,i)}function e(n,t,i){var u=r.Configuration&&r.Configuration.observableInsert;u(n,t,i)}var r=t.Observability=t.Observability||{};$.extend(r,{track:o,insert:s,remove:h,refresh:u,setProperty:f,observableInsert:e})})(this,Microsoft.ServiceModel.DomainServices),(function(n,t){var u=function(n,i){var u,r;this._inputData=n,this._skip=null,this._take=null,this._includeTotalCount=!1,this._observers=[],this._entities=[],this._lastRefreshTotalEntityCount=0,this._flushingDeferredEvents=!1;if(i&&i.entityCollection){if(Object.prototype.toString.call(i.entityCollection)!=="[object Array]")throw"Entity collection must be an array";u=i.entityCollection}this._clientEntities=u||[],r=this,this._clientEntities.deleteEntity=function(n){r._deleteEntity(n)},t.Observability.track(this._clientEntities,{afterChange:function(n,t,i){r._handleCollectionChange(i)},afterEvent:function(){r._flushDeferredEvents()}})},r={dispose:function(){this._observers&&(t.Observability.track(this._clientEntities,null),this._observers=null)},addObserver:function(n){$.inArray(n,this._observers)<0&&this._observers.push(n)},removeObserver:function(n){this._observers=$.grep(this._observers,function(t){return t!==n})},getEntities:function(){return this._clientEntities},getTotalEntityCount:function(){var n=$.grep(this._entities,function(n){return n.added}).length;return this._lastRefreshTotalEntityCount+n},getEntityState:function(n){return this._getCachedEntityByEntity(n)?this._inputData.getEntityState(n):null},isPropertyChanged:function(n,t){if(this._getCachedEntityByEntity(n))return this._inputData.isPropertyChanged(n,t);throw"Entity no longer cached in data source.";},getErrors:function(){var n=this;return $.grep(this._inputData.getErrors(),function(t){return!!n._getCachedEntityByEntity(t.entity)})},getDataContext:function(){throw"Unreachable";},getEntityValidationRules:function(){return this._inputData.getEntityValidationRules()},getEntityId:function(n){return this._inputData.getEntityId(n)},setSort:function(){throw"Unreachable";},setFilter:function(){throw"Unreachable";},setPaging:function(n){n=n||{},this._skip=n.skip,this._take=n.take,this._includeTotalCount=!!n.includeTotalCount},refresh:function(){throw"Unreachable";},revertChange:function(n,t){var i=this._getCachedEntityByEntity(n);if(i)this._inputData.revertChange(n,t),!t&&i.added&&this._purgeEntity(i.entity);else throw"Entity no longer cached in data source.";},revertChanges:function(n){this._inputData.revertChanges(n);var i=$.grep(this._entities,function(n){return n.added}),t=this;this._executeWithDeferredEvents(function(n){$.each(i,function(i,r){t._purgeEntity(r.entity,n)})})},_onPropertyChanged:function(n,t,i){var r=this._getCachedEntityByEntity(n);r&&this._raisePropertyChangedEvent(n,t,i)},_onEntityStateChanged:function(n,i){var f=this,r,u;$.each(this._entities,function(n,t){t.added&&f._inputData.getEntityState(t.entity)==="Unmodified"&&(t.added=!1)}),r=this._getCachedEntityByEntity(n),u=i==="Deleted"&&r&&(typeof this!==t.LocalDataSource||r.added),u&&this._purgeEntity(r.entity),r&&this._raiseEntityStateChangedEvent(n,i)},_raiseRefreshStartEvent:function(){this._raiseEvent("refreshStart")},_raiseRefreshEvent:function(n,t){this._raiseEvent("refresh",n,t)},_raisePropertyChangedEvent:function(n,t,i){this._raiseEvent("propertyChanged",n,t,i)},_raiseEntityStateChangedEvent:function(n,t){this._raiseEvent("entityStateChanged",n,t)},_raiseEvent:function(n){var r=[].slice.call(arguments,1),i=this._observers.slice(),t=this;$.each(i,function(i,u){$.isFunction(u[n])&&u[n].apply(t,r)})},_getCachedEntityByEntity:function(n){return $.grep(this._entities,function(t){return t.entity===n})[0]},_handleCollectionChange:function(n){var t,r,i;switch(n.change){case"insert":t=n.items;if(t.length>1)throw"NYI -- Can only add a single entity to/from an array in one operation.";r=t[0],this._addEntity(r);break;case"remove":i=n.items;if(i.length>1)throw"NYI -- Can only remove a single entity to/from an array in one operation.";throw"NYI -- Cannot apply destructive deletes to a entity collection.  Use 'deleteEntity' for non-destructive delete.";break;default:throw"NYI -- Array operation '"+n.change+"' is not supported.";}},_addEntity:function(n){this._entities.push({entity:n,added:!0});var i=this._inputData.getEntities();t.Observability.observableInsert(i,i.length,[n])},_deleteEntity:function(n){if(this._getCachedEntityByEntity(n))this._inputData.getEntities().deleteEntity(n);else throw"Entity no longer cached in data source.";},_purgeEntity:function(n,i){this._entities=$.grep(this._entities,function(t){return t.entity!==n});var u=$.inArray(n,this._clientEntities),r=t.Observability.remove(this._clientEntities,u,1);i?i.deferEvent(r):r&&r()},_processFilter:function(n){var e=n.property,f=n.value,t,r,u,i;if(n.operator){r={"<":["<","islessthan","lessthan","less","lt"],"<=":["<=","islessthanorequalto","lessthanequal","lte"],"==":["==","isequalto","equals","equalto","equal","eq"],"!=":["!=","isnotequalto","notequals","notequalto","notequal","neq","not"],">=":[">=","isgreaterthanorequalto","greaterthanequal","gte"],">":[">","isgreaterthan","greaterthan","greater","gt"]},u=n.operator.toLowerCase();for(i in r)if($.inArray(u,r[i])>-1){t=i;break}t||(t=n.operator)}else t="==";return{filterProperty:e,filterOperator:t,filterValue:f}},_flushDeferredEvents:function(){},_completeRefresh:function(n,i,r){var o,s,h,u,f,e;this._lastRefreshTotalEntityCount=i,s=this.getEntities(),s.length!==n.length?o=!0:$.each(s,function(t,i){if(i!==n[t])return o=!0,!1}),o&&(h=this,this._entities=$.map(n,function(n){var t=$.grep(h._entities,function(t){return t.entity===n&&t.added}).length>0;return{entity:n,added:t}}),u=t.Observability.refresh(this._clientEntities,n),u&&u()),f=this.getEntities(),e=this.getTotalEntityCount(),r&&r.completed&&$.isFunction(r.completed)&&r.completed(f,e),this._raiseRefreshEvent(f,e)},_executeWithDeferredEvents:function(n){this._assertNotFlushingDeferredEvents();var t=[],r={deferEvent:function(n){n&&t.push(n)}},i=n(r);try{this._flushingDeferredEvents=!0,$.each(t,function(n,t){t()})}finally{this._flushingDeferredEvents=!1}return i},_assertNotFlushingDeferredEvents:function(){if(this._flushingDeferredEvents)throw"Issuing side-effecting operations during event callbacks is not supported.";}};t.DataSource=t.defineClass(u,r)})(this,Microsoft.ServiceModel.DomainServices),(function(n,t,i){var u=function(n,i){this._dataContext=n,this._entityType=i,this._observers=[],this._updatedEntities=[],this._originalEntities=[],this._entityStates={},this._addedEntities=[],this._errors=[],this._clientEntities=[],this._deferredEvents=[],this._childEntitiesCollections={};var r=this;t.Observability.track(this._clientEntities,{afterChange:function(n,t,i){r._handleCollectionChange(i)},afterEvent:function(){r._flushDeferredEventsFromAddOrUpdate()}}),this._clientEntities.deleteEntity=function(n){r._deleteEntity(n)}},r={dispose:function(){this._observers&&(t.Observability.track(this._clientEntities,null),this._observers=null)},addObserver:function(n){$.inArray(n,this._observers)<0&&this._observers.push(n)},removeObserver:function(n){this._observers=$.grep(this._observers,function(t){return t!==n})},getEntities:function(){return this._clientEntities},getEntityState:function(n){var t=this.getEntityId(n);return t?this._entityStates[t]:null},getEntityId:function(n){var i=this._getAddedEntityFromEntity(n),t;if(i)return i.clientId;return t=$.inArray(n,this._updatedEntities),t>=0?this._getServerEntityId(this._originalEntities[t]).toString():null},isPropertyChanged:function(n,t){var u=this.getEntityId(n),r;switch(this._entityStates[u]){case"ClientUpdated":case"ServerUpdating":return r=this._getEntityIndexFromId(u),this._originalEntities[r][t]!==this._updatedEntities[r][t];case i:case"Deleted":throw"Entity no longer cached in data source.";default:return!1}},getErrors:function(){return this._errors},revertChange:function(n,i){var f=this.getEntityId(n),u=this._entityStates[f],r;if(!u||u==="Deleted")throw"Entity no longer cached in data source.";r=this,this._executeWithDeferredEvents(function(e){if(i)if(u!=="ClientUpdated")throw"Property change cannot be reverted for entity in state '"+u+"'.";else{var h=r._getEntityIndexFromId(f),o=r._originalEntities[h][i],s=t.Observability.setProperty(n,i,o);e.deferEvent(s),r._handlePropertyChangeInternal(n,i,o,e)}else if(u==="ClientDeleted"||u==="ClientUpdated")r._revertToOriginalEntity(f,e),r._errors=$.grep(r._errors,function(t,i){return i.entity!==n}),r._updateEntityState(f,"Unmodified",e);else if(u==="ClientAdded")r._purgeUncommittedAddedEntity(r._getAddedEntityFromId(f),!0,e);else throw"Entity changes cannot be reverted for entity in state '"+u+"'.";})},revertChanges:function(){var n=this;this._executeWithDeferredEvents(function(t){n.__revertChanges(t)})},__hasUncommittedEdits:function(){var n=!1;return $.each(this._entityStates,function(t,i){i!=="Unmodified"&&(n=!0)}),n},__loadEntities:function(n,i){var r=this,e=[],u=[],o=this._updatedEntities.length,f;return $.each(n,function(n,t){var f,c=r._getServerEntityId(t),o=r._getEntityIndexFromServerId(c),h,s;o<0?(f=$.extend({},t),r._addAssociationProperties(f),s=c.toString(),r._trackObservableForEntity(f),r._entityStates[s]="Unmodified",r._updatedEntities.push(f),r._originalEntities.push(t),u.push(f)):(h=r._originalEntities[o],f=r._updatedEntities[o],r._mergeOntoUpdatedEntity(f,t,h,i),r._originalEntities[o]=t),e.push(f)}),u.length>0&&(f=t.Observability.insert(this._clientEntities,o,u),i.deferEvent(f)),e},__getEditedEntities:function(){var t=this,n=[];return $.each(this._entityStates,function(i,r){r.indexOf("Client")===0&&n.push(t._getEntityFromId(i))}),n},__getEntityEdit:function(n){var i=this.getEntityId(n),u=this,f,t,e=this._getEntityIndexFromId(i),r=function(n){return $.extend({__type:u._entityType},n)},s,o;switch(this._entityStates[i]){case"ClientUpdated":f="ServerUpdating",t={Operation:3,Entity:r(this._updatedEntities[e]),OriginalEntity:r(this._originalEntities[e])};break;case"ClientAdded":f="ServerAdding",s=this._getAddedEntityFromId(i),t={Operation:2,Entity:r(s.entity)};break;case"ClientDeleted":f="ServerDeleting",t={Operation:4,Entity:r(this._originalEntities[e])};break;default:throw"Unrecognized entity state.";}return o={updateEntityState:function(n){u._updateEntityState(i,f,n)},operation:t,succeeded:function(n,r){return u._handleSubmitSucceeded(i,t,n,r)},failed:function(n,r){u._handleSubmitFailed(i,t,n,r)}}},__revertChanges:function(n){var u,r,t,i;$.each(this._entityStates,function(n,t){if(t.indexOf("Server")===0)return u=!0,!1});if(u)throw"Can't revert changes while a commit is in progress.";r=this,t=$.grep(this._addedEntities,function(n){return n.entity&&$.inArray(n.entity,r._updatedEntities)<0}),t.length>0&&(this._addedEntities=$.grep(this._addedEntities,function(n){return $.inArray(n,t)<0}),$.each(t,function(t,i){r._purgeUncommittedAddedEntity(i,!0,n)})),this._errors=[];for(i in this._entityStates)this._entityStates[i].indexOf("Client")===0&&(this._revertToOriginalEntity(i,n),this._updateEntityState(i,"Unmodified",n))},__handleEntitySetChanged:function(n,i){var l=(this._dataContext.__getMetadata(this._entityType)||{}).fields,o,s,c,u,f,e;if(!l)return;for(o in this._childEntitiesCollections){s=this._childEntitiesCollections[o],c=this._getEntityFromId(o);for(u in s){f=l[u];if(f.type===n){var r=s[u],a=this._computeAssociatedEntities(c,f),h=$.grep(a,function(n){return $.inArray(n,r)<0});$.each(h,function(n,u){var f=t.Observability.insert(r,r.length,[u]);i.deferEvent(f)}),e=$.grep(r,function(n){return $.inArray(n,a)<0}),$.each(e,function(n,u){var e=$.inArray(u,r),f=t.Observability.remove(r,e,1);i.deferEvent(f)}),(h.length>0||e.length>0)&&$.dataSource.unwrapHack(r).__syncToNewEntities()}}}},__getEntityType:function(){return this._entityType},_handleCollectionChange:function(n){var t,u,r,f,i;switch(n.change){case"insert":t=n.items;if(t.length>1)throw"NYI -- Can only add a single entity to/from an array in one operation.";u=t[0],r=this,this._executeWithDeferredEvents(function(n){r._addEntity(u,n)},!0);break;case"remove":f=n.index,i=n.items;if(i.length>1)throw"NYI -- Can only remove a single entity to/from an array in one operation.";throw"NYI -- Cannot apply destructive deletes to a entity collection.  Use 'deleteEntity' for non-destructive delete.";break;default:throw"NYI -- Array operation '"+n.change+"' is not supported.";}},_addEntity:function(n,t,i){if($.inArray(n,this._updatedEntities)>=0||this._getAddedEntityFromEntity(n))throw"Entity already in data source.";var r="added"+Math.floor(Math.random()*Math.pow(2,32)+1).toString(),u={entity:n,clientId:r};this._addedEntities.push(u),this._trackObservableForEntity(n),this._entityStates[r]="Unmodified",this._addAssociationProperties(n),this._updateEntityState(r,"ClientAdded",t),i||this._dataContext.__commitEntityIfImplicit(this,n,t),t.entitySetChanged(this._entityType)},_deleteEntity:function(n){var t=this;this._executeWithDeferredEvents(function(i){var r=t.getEntityId(n),e=t._getEntityIndexFromId(r),f=t._getAddedEntityFromId(r),o=e<0&&f,u;if(o){u=t._entityStates[r];if(u==="ClientAdded")t._purgeUncommittedAddedEntity(f,!0,i);else throw"NYI -- Can't edit a entity while previous edits are being committed.";}else if(e<0)throw"Entity no longer cached in data source.";else{if(t._entityStates[r].indexOf("Server")===0)throw"NYI -- Can't edit a entity while previous edits are being committed.";t._updateEntityState(r,"ClientDeleted",i),t._dataContext.__commitEntityIfImplicit(t,n,i)}})},_updateEntity:function(n,t){var r=$.inArray(n,this._updatedEntities),f=r<0&&this._getAddedEntityFromEntity(n),u,i;if(f){u=this._entityStates[this.getEntityId(n)];if(u!=="ClientAdded")throw"NYI -- Can't update an added entity while it's being committed.";}else if(r<0)throw"Entity no longer cached in data source.";else{i=this.getEntityId(n);if(this._entityStates[i].indexOf("Server")===0)throw"NYI -- Can't edit a entity while previous edits are being committed.";this._updateEntityState(i,"ClientUpdated",t)}this._dataContext.__commitEntityIfImplicit(this,n,t)},_updateEntityState:function(n,t,i,r,u){var o=this._entityStates[n],f,e;this._entityStates[n]&&(this._entityStates[n]=t),u=u||this._getEntityFromId(n),r&&(f=JSON.parse(r),this._errors.push({entity:u,error:f})),o!==t&&(e=this,i.deferEvent(function(){e._raiseEntityStateChangedEvent(u,t)}))},_purgeEntityAtIndex:function(n,i,r){var f=this._updatedEntities[n],u=this.getEntityId(f);t.Observability.track(f,null),this._updatedEntities=$.grep(this._updatedEntities,function(t,i){return i!==n}),this._originalEntities=$.grep(this._originalEntities,function(t,i){return i!==n}),this._purgeFromClientEntities(f,i,r),delete this._entityStates[u],this._disposeChildEntitiesCollections(u),this._getAddedEntityFromId(u)&&(this._addedEntities=$.grep(this._addedEntities,function(n){return n.clientId!==u})),this._errors=$.grep(this._errors,function(n,t){return t.entity!==f})},_raisePropertyChangedEvent:function(n,t,i){this._raiseEvent("propertyChanged",n,t,i)},_raiseEntityStateChangedEvent:function(n,t){this._raiseEvent("entityStateChanged",n,t)},_raiseEvent:function(n){var i=[].slice.call(arguments,1),t=this._observers.slice();$.each(t,function(t,r){$.isFunction(r[n])&&r[n].apply(null,i)})},_getServerEntityId:function(n){return this._dataContext.__getMetadata(this._entityType).getServerId(n)},_getEntityIndexFromId:function(n){var f=this._getAddedEntityFromId(n),r,u,t;if(f){if(f.serverId===i)return-1;r=f.serverId.toString()}else r=n;for(u=-1,t=0;t<this._originalEntities.length;t++)if(this._getServerEntityId(this._originalEntities[t]).toString()===r){u=t;break}return u},_getEntityIndexFromServerId:function(n){for(var i=-1,t=0;t<this._originalEntities.length;t++)if(this._getServerEntityId(this._originalEntities[t])===n){i=t;break}return i},_trackObservableForEntity:function(n){var i=this;t.Observability.track(n,{afterChange:function(n,t,r){i._handlePropertyChange(n,r)},afterEvent:function(){i._flushDeferredEventsFromAddOrUpdate()}})},_handlePropertyChange:function(n,t){var i=t.path,f=t.value,r,u;if(i==="")return;r=this.getEntityId(n);if(this._entityStates[r]==="Unmodified"&&n[i]===this._originalEntities[this._getEntityIndexFromId(r)][i])return;u=this,this._executeWithDeferredEvents(function(t){u._handlePropertyChangeInternal(n,i,f,t)},!0)},_handlePropertyChangeInternal:function(n,t,i,r){var u=this;r.deferEvent(function(){u._raisePropertyChangedEvent(n,t,i)}),this._updateEntity(n,r),r.entitySetChanged(this._entityType)},_mergeOntoUpdatedEntity:function(n,i,r,u){var e=this,f;$.each(i,function(i,o){var h=r&&n[i]!==r[i],s;h||n[i]!==o&&(f=!0,s=t.Observability.setProperty(n,i,o),u.deferEvent(s),u.deferEvent(function(){e._raisePropertyChangedEvent(n,i,o)}))}),f&&u.entitySetChanged(this._entityType)},_getAddedEntityFromId:function(n){var t=$.grep(this._addedEntities,function(t){return t.clientId===n});return t[0]},_getAddedEntityFromEntity:function(n){var t=$.grep(this._addedEntities,function(t){return t.entity===n});return t[0]},_handleSubmitSucceeded:function(n,t,i,r){var e=!0,f=this._getEntityFromId(n),c,o,s;switch(t.Operation){case 2:if(i.ValidationErrors)e=!1,c=this,$.each(i.ValidationErrors,function(n,t){c._errors.push({entity:f,error:t})}),this._updateEntityState(n,"ClientAdded",r);else{var h=i.Entity,u=this._getAddedEntityFromId(n),l=u.entity;u.serverId=this._getServerEntityId(h),this._updatedEntities.push(l),this._originalEntities.push(h),this._revertToOriginalEntity(u.clientId,r),this._updateEntityState(n,"Unmodified",r)}break;case 3:o=i.Entity,this._originalEntities[this._getEntityIndexFromId(n)]=o,this._revertToOriginalEntity(n,r),this._updateEntityState(n,"Unmodified",r);break;case 4:s=this._getEntityIndexFromId(n),this._purgeEntityAtIndex(s,!0,r),this._updateEntityState(n,"Deleted",r,null,f)}return e&&(this._errors=$.grep(this._errors,function(n,t){return t.entity!==f})),e},_handleSubmitFailed:function(n,t,i,r){var u;switch(t.Operation){case 2:u="ClientAdded";break;case 3:u="ClientUpdated";break;case 4:u="ClientDeleted"}this._updateEntityState(n,u,r,i.responseText)},_revertToOriginalEntity:function(n,t){var i=this._getEntityIndexFromId(n);this._mergeOntoUpdatedEntity(this._updatedEntities[i],this._originalEntities[i],null,t)},_purgeUncommittedAddedEntity:function(n,i,r){var f=n.clientId,u=n.entity;t.Observability.track(u,null),this._addedEntities=$.grep(this._addedEntities,function(t){return t!==n}),delete this._entityStates[f],this._disposeChildEntitiesCollections(f),this._errors=$.grep(this._errors,function(n,t){return t.entity!==u}),this._purgeFromClientEntities(u,i,r),this._updateEntityState(f,"Deleted",r,null,u)},_purgeFromClientEntities:function(n,i,r){var f=$.inArray(n,this._clientEntities),u=t.Observability.remove(this._clientEntities,f,1);i&&r.deferEvent(u),r.entitySetChanged(this._entityType)},_getEntityFromId:function(n){var t=this;return $.grep(this.getEntities(),function(i){return t.getEntityId(i)===n})[0]},_executeWithDeferredEvents:function(n,t){var r;this._assertNotFlushingDeferredEvents();var i=[],f,u={deferEvent:function(n){n&&i.push(n)},entitySetChanged:function(){f=!0}},e=n(u);return f&&this._dataContext.__entitySetChanged(this._entityType,u),t?(r=this,$.each(i,function(n,t){r._deferredEvents.push(t)})):this._flushDeferredEvents(i),e},_flushDeferredEventsFromAddOrUpdate:function(){if(this._deferredEvents.length!==0){var n=this._deferredEvents;this._deferredEvents=[],this._flushDeferredEvents(n)}},_flushDeferredEvents:function(n){try{this._flushingDeferredEvents=!0,$.each(n,function(n,t){t()})}finally{this._flushingDeferredEvents=!1}},_assertNotFlushingDeferredEvents:function(){if(this._flushingDeferredEvents)throw"Issuing side-effecting operations during event callbacks is not supported.";},_addAssociationProperties:function(n){var i=(this._dataContext.__getMetadata(this._entityType)||{}).fields,t;i&&(t=this,$.each(i,function(i,r){r.association&&(r.association.isForeignKey?(n["get_"+i]=function(){return t._getParentEntity(n,i)},n["set_"+i]=function(r){return t._setParentEntity(n,i,r)}):r.array&&(n["get_"+i]=function(){return t._getChildEntities(n,i)}))}))},_getParentEntity:function(n,t){var r=this._dataContext.__getMetadata(this._entityType).fields[t],i=this._computeAssociatedEntities(n,r)[0];return i||null},_setParentEntity:function(n,r,u){var h=this._dataContext.__getMetadata(this._entityType).fields[r],a=this._dataContext.getEntitySet(h.type),c,f,e,o,s,l;if($.inArray(u,a.getEntities())<0)throw"Parent entity is not in the parent entity set for this association.";else if((a.getEntityState(u)||"").indexOf("Add")>0)throw"NYI -- Cannot set foreign keys to key values computed from added entities.  Commit your parent entity first.";c=h.association.otherKey,f=u?u[c[0]]:null;if(f===i)throw"Parent entity has no value for its '"+c[0]+"' key property.";e=h.association.thisKey,o=n[e[0]],u?(o===i||o!==f)&&(s=!0):o!==null&&(s=!0),s&&(l=this,this._executeWithDeferredEvents(function(i){var r=t.Observability.setProperty(n,e[0],f);i.deferEvent(r),l._handlePropertyChangeInternal(n,e[0],f,i)}))},_getChildEntities:function(n,r){var s=this.getEntityId(n),e=this._childEntitiesCollections[s],u,f;e||(e=this._childEntitiesCollections[s]={}),u=e[r];if(!u){f=this._dataContext.__getMetadata(this._entityType).fields[r],u=this._computeAssociatedEntities(n,f);var o=this,l=function(t){var e,r,h,s;if((o.getEntityState(n)||"").indexOf("Add")>0)throw"NYI -- Cannot set foreign keys to key values computed from added entities.  Commit the parent entity first.";e=f.association.thisKey,r=n[e[0]];if(r===i)throw"Parent entity has no value for its '"+e[0]+"' key property.";h=f.association.otherKey,s=o._dataContext.getEntitySet(f.type),s._handleAddToChildEntitiesCollection(t,h,r,function(){$.dataSource.unwrapHack(u).__syncToNewEntities()})},c=function(){var n=o._dataContext.getEntitySet(f.type);n._flushDeferredEventsFromAddOrUpdate()},h=new t.AssociatedEntitiesDataSource(this._dataContext,f.type,u,l,c);$.dataSource.wrapHack(u,h),e[r]=u}return u},_computeAssociatedEntities:function(n,t){var u=n[t.association.thisKey[0]],r=this._dataContext.getEntitySet(t.type);return r._getTargetEntities(t.association.otherKey,u)},_getTargetEntities:function(n,t){return $.grep(this._clientEntities,function(r){var u=r[n[0]];return u!==i&&u===t})},_disposeChildEntitiesCollections:function(n){var t=this._childEntitiesCollections[n];t&&$.each(t,function(n,t){$([t]).dataSource().destroy()}),delete this._childEntitiesCollections[n]},_handleAddToChildEntitiesCollection:function(n,r,u,f){var e=this;this._executeWithDeferredEvents(function(o){var c=n[r[0]],l=c===i||c!==u,s,h;$.inArray(n,e.getEntities())<0&&(o.deferEvent(t.Observability.insert(e._clientEntities,e._clientEntities.length,[n])),h=l,e._addEntity(n,o,h),s=!0),l&&(o.deferEvent(t.Observability.setProperty(n,r[0],u)),e._handlePropertyChangeInternal(n,r[0],u,o),s=!0),s&&f()},!0)}};t.EntitySet=t.defineClass(u,r)})(this,Microsoft.ServiceModel.DomainServices),(function(n,t){var u=function(n,i,r){var f,u;this._serviceUrl=n,this._changeTracking=!!r;if(i){u=t[i+"DataProvider"];if(!u)throw"There is no provider available for the format '"+i+"'";f=new u(n)}else f=new t.DataProvider(n);this._dataProvider=f,this._observers=[],this._entitySets={},this._flushingDeferredEvents=!1,this._metadata={}},r={dispose:function(){},addObserver:function(n){$.inArray(n,this._observers)<0&&this._observers.push(n)},removeObserver:function(n){this._observers=$.grep(this._observers,function(t){return t!==n})},getEntitySet:function(n){var i=this._entitySets[n];return i||(i=this._entitySets[n]=new t.EntitySet(this,n)),i},getErrors:function(){var n=[];return $.each(this._entitySets,function(t,i){var r=[n.length,0].concat(i.getErrors());[].splice.apply(n,r)}),n},commitChanges:function(){var n,t;if(!this._changeTracking)throw"Data context must be in change-tracking mode to explicitly commit changes.";n=[],$.each(this._entitySets,function(t,i){var u=$.map(i.__getEditedEntities(),function(n){return{entitySet:i,entity:n}}),r=[n.length,0].concat(u);[].splice.apply(n,r)}),t=this,this._executeWithDeferredEvents(function(i){t._submitChanges(n,i)})},revertChanges:function(){var n=this;this._executeWithDeferredEvents(function(t){$.each(n._entitySets,function(n,i){i.__revertChanges(t)})})},merge:function(n,t,i){var u=this,r;return this._executeWithDeferredEvents(function(f){i&&$.each(i,function(n,t){var i=u.getEntitySet(n);i.__loadEntities(t,f)});var e=t&&u.getEntitySet(t);r=e?e.__loadEntities(n,f):[]}),r},addMetadata:function(n,t){if(!this._metadata[n]){var i=this._entitySets[n];if(i&&i.getEntities().length)throw"Cannot add metadata for type once data of that type has been merged into this DataContext.";this._metadata[n]=t}},__load:function(n,t){$.each(this._entitySets,function(n,t){if(t.__hasUncommittedEdits())throw"Load is not allowed while the data source contains uncommitted edits.";});var r=this._dataProvider,i=this;r.get(n.queryName,n.queryParameters,n).done(function(n){n=r.load(n,i),t(i.getEntitySet(n.type),n.entities,n.totalCount)})},__commitEntityIfImplicit:function(n,t,i){this._changeTracking||this._submitChanges([{entitySet:n,entity:t}],i)},__entitySetChanged:function(n,t){this._distributeEntitySetChanged(n,t)},__getMetadata:function(n){return this._metadata[n]},_raiseCommitEvent:function(){this._raiseEvent("commit")},_raiseCommittingEvent:function(){this._raiseEvent("commitStart")},_raiseEvent:function(n){var i=[].slice.call(arguments,1),t=this._observers.slice();$.each(t,function(t,r){$.isFunction(r[n])&&r[n].apply(null,i)})},_submitChanges:function(n,t){var i;this._raiseCommittingEvent(),i=$.map(n,function(n){return n.entitySet.__getEntityEdit(n.entity)}),$.each(i,function(n,i){i.updateEntityState(t)});var e=$.map(i,function(n,t){return $.extend({Id:t.toString()},n.operation)}),r=this,f=function(n){var t=r._executeWithDeferredEvents(function(t){for(var u,r=0;r<n.length;r++){u=i[r];if(!u.succeeded(n[r],t))return!0}return!1});t||r._raiseCommitEvent()},u=function(n){r._executeWithDeferredEvents(function(t){$.each(i,function(i,r){r.failed(n,t)})})};this._dataProvider.post("SubmitChanges",{changeSet:e}).then(f,u)},_executeWithDeferredEvents:function(n){var i;this._assertNotFlushingDeferredEvents();var r=[],u={},t={deferEvent:function(n){n&&r.push(n)},entitySetChanged:function(n){u[n]=!0}},f=n(t);for(i in u)this._distributeEntitySetChanged(i,t);try{this._flushingDeferredEvents=!0,$.each(r,function(n,t){t()})}finally{this._flushingDeferredEvents=!1}return f},_distributeEntitySetChanged:function(n,t){var r,i;for(r in this._entitySets)i=this._entitySets[r],i.__handleEntitySetChanged(n,t)},_assertNotFlushingDeferredEvents:function(){if(this._flushingDeferredEvents)throw"Issuing side-effecting operations during event callbacks is not supported.";}};t.DataContext=t.defineClass(u,r)})(this,Microsoft.ServiceModel.DomainServices),(function(n,t,i){function e(n){var t={},u,e,r,f;return n.$where||n.where?t.$where=n.$where||n.where:n.filters&&(u="",e=function(n,t,i){typeof t=="string"&&(t='"'+t+'"');switch(i){case"<":case"<=":case"==":case"!=":case">=":case">":return n+i+t;case"StartsWith":case"EndsWith":case"Contains":return n+"."+i+"("+t+")";default:throw"The operator '"+i+"' is not supported.";}},$.each(n.filters,function(n,t){n>0&&(u+=" AND "),u+=t.filterValue===i?t.filterProperty:e(t.filterProperty,t.filterValue,t.filterOperator||"==")}),t.$where=u),n.$orderby||n.orderby?t.$orderby=n.$orderby||n.orderby:n.sort&&(r="",f=function(n){return n.property+(n.direction?" "+n.direction:"")},Object.prototype.toString.call(n.sort)==="[object String]"?r=n.sort:Object.prototype.toString.call(n.sort)==="[object Array]"?$.each(n.sort,function(n,t){n>0&&(r+=","),r+=f(t)}):r=f(n.sort),t.$orderby=r),(n.$skip||n.skip)&&(t.$skip=n.$skip||n.skip),(n.$take||n.take)&&(t.$take=n.$take||n.take),(n.$includeTotalCount||n.includeTotalCount)&&(t.$includeTotalCount=n.$includeTotalCount||n.includeTotalCount),t}function r(n){return n&&$.each(n||{},function(t,i){$.isArray(i)&&(n[t]=JSON.stringify(i))}),n}var f=function(n){this._serviceUrl=n},u={get:function(n,t,i){var u=this._serviceUrl.substring(this._serviceUrl.length-1)!=="/"?"/":"";return $.ajax({url:this._serviceUrl+u+"json/"+n,data:$.extend({},r(t),e(i||{})),dataType:"json"})},load:function(n,t){var e,i,r,u,f;return $.each(n,function(n){if(/Result$/.test(n))return e=n,!1}),i=n[e],$.each(i.Metadata,function(n,i){t.addMetadata(i.type,{getServerId:function(n){return n[i.key[0]]},fields:i.fields,rules:i.rules,messages:i.messages})}),$.each(i.RootResults,function(n,t){delete t.__type}),r={},i.IncludedResults&&$.each(i.IncludedResults,function(n,t){var u=t.__type,i;delete t.__type,i=r[u]||(r[u]=[]),i.push(t)}),u=i.Metadata[0].type,f=t.merge(i.RootResults,u,r),{entities:f,type:u,totalCount:i.TotalCount||0}},post:function(n,t){var i=$.Deferred(),u=this._serviceUrl.substring(this._serviceUrl.length-1)!=="/"?"/":"",r=JSON.stringify(t);return $.ajax({url:this._serviceUrl+u+"json/"+n,contentType:"application/json",data:r,dataType:"json",type:"POST",success:function(t){var r=t[n+"Result"];$.each(r,function(n,t){t.Entity&&delete t.Entity.__type}),i.resolve(r)},error:function(n){i.reject(n)}}),i.promise()}};t.DataProvider=t.defineClass(f,u)})(this,Microsoft.ServiceModel.DomainServices),(function(n,t){var u=function(n,i,r,u){var s,h,c,e,f,o;this._entitySet=null,this._sort=null,this._filters=null;if(u){s=u.format,h=u.queryParameters,c=u.bufferChanges,e=u.dataContext;if(!e&&u.entityCollection&&u.entityCollection.length!==0)throw"NYI -- Currently, entity collection must be empty to bind to a data source.";}this._queryName=i,this._queryParameters=h,e||(e=new t.DataContext(n,s,!!c)),this._dataContext=e,f=this,this._dataContextObserver={commitStart:function(){f._onCommitStart()},commit:function(){f._onCommit()}},this._dataContext.addObserver(this._dataContextObserver),this._entitySetObserver={propertyChanged:function(n,t,i){f._onPropertyChanged(n,t,i)},entityStateChanged:function(n,t){f._onEntityStateChanged(n,t)}},r,o={getEntities:function(){return f._entitySet.getEntities()},getEntityState:function(n){return f._entitySet.getEntityState(n)},getEntityValidationRules:function(){return{rules:f._dataContext.__getMetadata(f._getEntityType()).rules,messages:f._dataContext.__getMetadata(f._getEntityType()).messages}},isPropertyChanged:function(n,t){return f._entitySet.isPropertyChanged(n,t)},getErrors:function(){return f._dataContext.getErrors()},revertChange:function(n,t){return f._entitySet.revertChange(n,t)},revertChanges:function(n){n?f._dataContext.revertChanges():f._entitySet.revertChanges()},getEntityId:function(n){return f._entitySet.getEntityId(n)}},this._super.constructor.call(this,o,u)},r={dispose:function(){t.DataSource.prototype.dispose.apply(this),this._dataContextObserver&&(this._dataContext.removeObserver(this._dataContextObserver),this._dataContextObserver=null),this._entitySetObserver&&this._entitySet&&(this._entitySet.removeObserver(this._entitySetObserver),this._entitySetObserver=null)},getDataContext:function(){return this._dataContext},setSort:function(n){this._sort=n},setFilter:function(n){if(n)if(Object.prototype.toString.call(n)==="[object Array]"){var t=this;this._filters=$.map(n,function(n){return t._processFilter(n)})}else this._filters=[this._processFilter(n)];else this._filters=null},refresh:function(n){this._raiseRefreshStartEvent();var t=this,i=function(i,r,u){t._bindToEntitySet(i),t._completeRefresh(r,u,n)};this._dataContext.__load({queryName:this._queryName,queryParameters:this._queryParameters,filters:this._filters,sort:this._sort,skip:this._skip,take:this._take,includeTotalCount:this._includeTotalCount},i)},commitChanges:function(){this._dataContext.commitChanges()},_onCommitStart:function(){this._raiseCommitStartEvent()},_onCommit:function(){this._raiseCommitEvent()},_raiseCommitStartEvent:function(){this._raiseEvent("commitStart")},_raiseCommitEvent:function(){this._raiseEvent("commit")},_bindToEntitySet:function(n){n!==this._entitySet&&(this._entitySet&&this._entitySet.removeObserver(this._entitySetObserver),this._entitySet=n,this._entitySet&&this._entitySet.addObserver(this._entitySetObserver))},_getEntityType:function(){return this._entitySet.__getEntityType()}};t.RemoteDataSource=t.deriveClass(t.DataSource,u,r)})(this,Microsoft.ServiceModel.DomainServices),(function(n,t){var u=function(n,t,i,r,u){var e={dataContext:n,entityCollection:i},f;this._super.constructor.call(this,null,null,t,e),f=n.getEntitySet(t),this._bindToEntitySet(f),this._handleAddEntity=r,this._flushDeferredEventsFromAdd=u,this.__syncToNewEntities()},r={getTotalEntityCount:function(){return this._entities.length},setSort:function(){throw"Associated entities collections don't support query.";},setFilter:function(){throw"Associated entities collections don't support query.";},setPaging:function(){throw"Associated entities collections don't support query.";},refresh:function(){throw"Associated entities collections refresh implicitly.";},__syncToNewEntities:function(){this._entities=$.map(this._clientEntities,function(n){return{entity:n}})},_addEntity:function(n){this._handleAddEntity(n)},_purgeEntity:function(){},_flushDeferredEvents:function(){this._flushDeferredEventsFromAdd()}};t.AssociatedEntitiesDataSource=t.deriveClass(t.RemoteDataSource,u,r)})(this,Microsoft.ServiceModel.DomainServices),(function(n,t,i){var u=function(n,i){var f,r,u;if(i&&i.entityCollection&&i.entityCollection.length!==0)throw"NYI -- Currently, entity collection must be empty to bind to a data source.";f="_lastRefreshTotalEntityCount"in n;if(!(f||n instanceof t.EntitySet))throw"Currently, local data sources only accept DataSource- and EntitySet-typed input data.";this._inputDataSourceOrEntitySet=n,this._sort=null,this._filter=null,this._refreshAllInProgress=!1,this._resultsStale=!0,this._deferredResultsStaleEvent=!1,r=this,this._observer={refreshStart:function(){r._onRefreshStart()},refresh:function(n){r._onRefresh(n)},propertyChanged:function(n,t,i){r._onPropertyChanged(n,t,i)},entityStateChanged:function(n,t){r._onEntityStateChanged(n,t)},commit:function(){r._onCommit()},resultsStale:function(){r._onResultsStale()}},n.addObserver(this._observer),this._innerArrayChangeHandler=function(n,t){r._handleInnerCollectionChange(n,t)},$([n.getEntities()]).bind("arrayChange",this._innerArrayChangeHandler),u={getEntities:function(){return n.getEntities()},getEntityState:function(t){return n.getEntityState(t)},getEntityValidationRules:function(){return n.getEntityValidationRules()},isPropertyChanged:function(t,i){return n.isPropertyChanged(t,i)},getErrors:function(){return n.getErrors()},revertChange:function(t,i){return n.revertChange(t,i)},revertChanges:function(t){return n.revertChanges(t)},getEntityId:function(t){return n.getEntityId(t)}},this._super.constructor.call(this,u,i)},r={dispose:function(){t.DataSource.prototype.dispose.apply(this),this._observer&&(this._inputDataSourceOrEntitySet.removeObserver(this._observer),this._observer=null),this._innerArrayChangeHandler&&($([this._inputDataSourceOrEntitySet.getEntities()]).unbind("arrayChange",this._innerArrayChangeHandler),this._innerArrayChangeHandler=null)},getDataContext:function(){return this._inputDataSourceOrEntitySet.getDataContext&&this._inputDataSourceOrEntitySet.getDataContext()},setSort:function(n){this._sort=n},setFilter:function(n){this._filter=n&&this._createFilterFunction(n)},refresh:function(n){function i(i){t._resultsStale=!1;var r=t._applyQuery(i);t._completeRefresh(r.entities,r.totalCount,n)}this._raiseRefreshStartEvent();var t=this;n&&!!n.all&&this._inputDataSourceOrEntitySet.refresh?(this._refreshAllInProgress=!0,this._inputDataSourceOrEntitySet.refresh({all:!0,completed:function(n){i(n),t._refreshAllInProgress=!1}})):setTimeout(function(){i(t._inputDataSourceOrEntitySet.getEntities())})},areResultsStale:function(){return this._resultsStale},_onRefreshStart:function(){},_onRefresh:function(n){var i,u,r,f,t;if(this._refreshAllInProgress)return;if(!this._resultsStale){i=!1,u=this._applyQuery(n);if(this.totalCount!==u.totalCount)i=!0;else{r=this.getEntities(),f=u.entities;if(r.length!==f.length)i=!0;else for(t=0;t<r.length;t++)if(r[t]!==f[t]){i=!0;break}}i&&this._setResultsStale()}},_normalizePropertyValue:function(n,t){return n[t]||""},_onPropertyChanged:function(n,i){t.DataSource.prototype._onPropertyChanged.apply(this,arguments);if(this._refreshAllInProgress)return;if(!this._resultsStale){var u=!1;this._filter&&!this._filter(n)&&(u=!0),this._getCachedEntityByEntity(n)&&this._sort&&(u=$.isFunction(this._sort)?!0:Object.prototype.toString.call(this._sort)==="[object Array]"?$.grep(this._sort,function(n){return n.property===i}).length>0:this._sort.property===i),u&&this._setResultsStale()}},_onCommit:function(){},_onResultsStale:function(){},_raiseResultsStaleEvent:function(){this._deferredResultsStaleEvent=!1,this._raiseEvent("resultsStale")},_createFilterFunction:function(n){function i(n){if($.isFunction(n))return n;var u=r._processFilter(n),f=u.filterProperty,e=u.filterOperator,t=u.filterValue,i;switch(e){case"<":i=function(n){return n<t};break;case"<=":i=function(n){return n<=t};break;case"==":i=function(n){return n==t};break;case"!=":i=function(n){return n!=t};break;case">=":i=function(n){return n>=t};break;case">":i=function(n){return n>t};break;case"Contains":i=function(n){return typeof n=="string"&&typeof t=="string"&&(n=n.toLowerCase(),t=t.toLowerCase()),n.indexOf(t)>=0};break;default:throw"Unrecognized filter operator.";}return function(n){var t=r._normalizePropertyValue(n,f);return i(t)}}var r=this,t;return Object.prototype.toString.call(n)==="[object Array]"?(t=$.map(n,function(n){return i(n)}),function(n){for(var i=0;i<t.length;i++)if(!t[i](n))return!1;return!0}):i(n)},_getSortFunction:function(){function t(n){return function(t,r){var e=(n.direction||"asc").toLowerCase().indexOf("asc")===0,f=i._normalizePropertyValue(t,n.property),u=i._normalizePropertyValue(r,n.property);return f==u?0:f>u?e?1:-1:e?-1:1}}var i=this,n;return this._sort?$.isFunction(this._sort)?this._sort:Object.prototype.toString.call(this._sort)==="[object Array]"?($.each(this._sort,function(i,r){var u=t(r);n=n?function(n,t){return function(i,r){var u=n(i,r);return u===0?t(i,r):u}}(n,u):u}),n):t(this._sort):null},_applyQuery:function(n){var s=this,r,f,t,o,u,e;return r=this._filter?$.grep(n,function(n){return s._filter(n)}):n,f=this._getSortFunction(),t=f?r.sort(f):r,o=this._skip||0,u=t.slice(o),this._take&&(u=u.slice(0,this._take)),e=this._includeTotalCount?t.length:i,{entities:u,totalCount:e}},_handleInnerCollectionChange:function(n,t){var r,u,f;if(this._refreshAllInProgress)return;if(!this._resultsStale){var o=this,i=!1,e=function(n){return $.grep(n,function(n){return!!o._getCachedEntityByEntity(n)}).length>0};switch(t.change){case"insert":r=t.items,r.length>0&&(u=this._filter||function(){return!0},f=$.grep(r,function(n){return u(n)&&$.grep(o._entities,function(t){return t.entity===n&&t.added}).length===0}).length>0,f&&(i=!0));break;case"remove":e(t.items)&&(i=!0);break;case"refresh":i=!0;break;case"move":!this._sort&&e(t.items)&&(i=!0);break;default:throw"Unknown array operation '"+t.change+"'.";}i&&this._setResultsStale()}},_setResultsStale:function(n){this._resultsStale=!0,n?this._deferredResultsStaleEvent=!0:this._raiseResultsStaleEvent()},_addEntity:function(n){t.DataSource.prototype._addEntity.apply(this,arguments),this._filter&&!this._filter(n)&&this._setResultsStale()},_flushDeferredEvents:function(){this._deferredResultsStaleEvent&&this._raiseResultsStaleEvent()}};t.LocalDataSource=t.deriveClass(t.DataSource,u,r)})(this,Microsoft.ServiceModel.DomainServices),(function(n){function i(n,t){if(t){var i=n.__dataSource__;i&&i.destroy(),n.__dataSource__=r(n,t)}return n.__dataSource__}function r(i,r){var e=Microsoft.ServiceModel.DomainServices,u,f;if(r.serviceUrl)u=new e.RemoteDataSource(r.serviceUrl,r.queryName,r.entityType,{format:r.format,queryParameters:r.queryParameters,bufferChanges:r.bufferChanges,dataContext:r.dataContext,entityCollection:i});else if(r.inputData)f=r.inputData.__dataSource__?n.dataSource.unwrapHack(r.inputData):r.inputData,u=new e.LocalDataSource(f,{entityCollection:i});else throw"Must provide either server parameters or an input array.";return t(u).options(r)}function t(i){function l(t){t=t||{},n.each(["filter","sort","paging","refreshing","refresh","committing","commit","queryResultsStale","entityStateChange"],function(n,i){c(i,t[i])})}function c(n,t){switch(n){case"filter":i.setFilter(t);break;case"sort":i.setSort(t);break;case"paging":i.setPaging(t);break;case"refreshing":o=t;break;case"refresh":s=t;break;case"committing":h=t;break;case"commit":e=t;break;case"queryResultsStale":u=t;break;case"entityStateChange":f=t;break;default:throw"Unrecognized option '"+n+"'";}}var o,s,h,e,u,f,r,a={refreshStart:function(){n(r).trigger("datasourcerefreshing",arguments),o&&o.apply(null,arguments)},refresh:function(){n(r).trigger("datasourcerefresh",arguments),s&&s.apply(null,arguments)},commitStart:function(){n(r).trigger("datasourcecommitting",arguments),h&&h.apply(null,arguments)},commit:function(){n(r).trigger("datasourcecommit",arguments),e&&e.apply(null,arguments)},resultsStale:function(){n(r).trigger("datasourcequeryresultsstale",arguments),u&&u.apply(null,arguments)},entityStateChanged:function(){n(r).trigger("datasourceentitiestatechange",arguments),f&&f.apply(null,arguments)}};return i.addObserver(a),r={applyLocalQuery:function(n){var f=Microsoft.ServiceModel.DomainServices,u=new f.LocalDataSource(i),r=u.getEntities();return r.__dataSource__=t(u),r.__dataSource__.options(n),r},options:function(n){return l(n),this},option:function(n,t){return c(n,t),this},refresh:function(t){if(t){var r;n.each(t,function(n){n!=="all"&&n!=="completed"&&(r=!0)}),r&&l(t)}return i.refresh(t),this},commitChanges:function(){return i.commitChanges(),this},revertChanges:function(n,t){return typeof n=="object"?i.revertChange(n,t):i.revertChanges(!!n),this},destroy:function(){return i&&(delete i.getEntities().__dataSource__,i.removeObserver(a),i.dispose(),i=null),this},getEntities:function(){return i.getEntities()},getEntityState:function(n){return i.getEntityState(n)},getEntityValidationRules:function(){return i.getEntityValidationRules()},getErrors:function(){return i.getErrors()},isPropertyChanged:function(n,t){return i.isPropertyChanged(n,t)},dataContext:function(){return i.getDataContext()},getTotalCount:function(){return i.getTotalEntityCount()},getEntityId:function(n){return i.getEntityId(n)},_dataSource:i}}n.fn.extend({dataSource:function(n){return i(this[0],n)}}),n.dataSource=function(n){if(n){var t=n.entityCollection||[];return delete n.entityCollection,i(t,n)}throw"Provide construction options to $.dataSource";},n.dataSource.wrapHack=function(n,i){n.__dataSource__=t(i)},n.dataSource.unwrapHack=function(n){return n.__dataSource__._dataSource}})(jQuery),(function(n,t,i){function e(n){var t={},u,i,r;return n.$filter||n.filter?t.$filter=n.$filter||n.filter:n.filters&&(u=function(n,t,i){typeof i=="string"&&(i="'"+i+"'");switch(t){case"<":return n+" lt "+i;case"<=":return n+" le "+i;case"==":return n+" eq "+i;case"!=":return n+" ne "+i;case">=":return n+" ge "+i;case">":return n+" gt "+i;case"StartsWith":return"startswith("+n+","+i+") eq true";case"EndsWith":return"endswith("+n+","+i+") eq true";case"Contains":return"substringof("+i+","+n+") eq true";default:throw"The operator '"+t+"' is not supported.";}},t.$filter=$.map(n.filters,function(n){return u(n.filterProperty,n.filterOperator,n.filterValue)}).join(" and ")),n.$orderby||n.orderby?t.$orderby=n.$orderby||n.orderby:n.sort&&(i="",r=function(n){return n.direction==="descending"?n.property+" desc":n.property},i=typeof n.sort=="string"?n.sort:$.isArray(n.sort)?$.map(n.sort,function(n){return r(n)}).join():r(n.sort),t.$orderby=i),(n.$skip||n.skip)&&(t.$skip=n.$skip||n.skip),(n.$take||n.take||n.$top||n.top)&&(t.$top=n.$take||n.take||n.$top||n.top),(n.$expand||n.expand)&&(t.$expand=n.$expand||n.expand),(n.$format||n.format)&&(t.$format=n.$format||n.format),(n.$select||n.select)&&(t.$select=n.$select||n.select),n.$inlinecount||n.inlinecount?t.$inlinecount=n.$inlinecount||n.inlinecount:(n.$includeTotalCount||n.includeTotalCount)&&(t.$inlinecount="allpages"),t}function r(n){var i,t,u;for(i in n){t=n[i];if(t===null)continue;else if($.isArray(t))for(u in t)r(u);else typeof t=="object"?(o(t)&&(n[i]=t=t.results),r(t)):t&&t.match&&t.match(/\/Date\([+\-]?\d+[+\-]?\d*\)\//)&&(n[i]=new Date(+t.replace(/\/Date\(([+\-]?\d+)[+\-]?\d*\)\//,"$1")))}return n}function o(n){var i=0,t;for(t in n)if(++i>1)return!1;return!!n.results}var u=function(n){this._serviceUrl=n},f={get:function(n,t,i){var u=this._serviceUrl,s=u.substring(u.length-1)!=="/"?u+"/":u,f=[],o,r;return $.each($.extend({},t,e(i||{})),function(n,t){f.push(n.toString()+"="+t.toString())}),o=f.length?"?"+f.join("&"):"",r=$.Deferred(),OData.read(s+n+o,function(n){r.resolve(n)},function(n){r.reject(n)}),r},load:function(n,t){var f=r(n.results),u=f.length&&f[0].__metadata.type;u&&t.addMetadata(u,{getServerId:function(n){return n.__metadata.uri}});var s=t.merge(f,u),e=n.__count,o=e===i?null:+e;return{entities:s,type:u,totalCount:o}},post:function(){throw"Saving edits through the OData data provider is not supported.";}};t.ODataDataProvider=t.defineClass(u,f)})(this,Microsoft.ServiceModel.DomainServices);